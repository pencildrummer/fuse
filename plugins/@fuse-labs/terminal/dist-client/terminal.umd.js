var ee=Object.defineProperty;var M=Object.getOwnPropertySymbols;var te=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var re=(s,c,i)=>c in s?ee(s,c,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[c]=i;var j=(s,c)=>{var i={};for(var l in s)te.call(s,l)&&c.indexOf(l)<0&&(i[l]=s[l]);if(s!=null&&M)for(var l of M(s))c.indexOf(l)<0&&ne.call(s,l)&&(i[l]=s[l]);return i};var h=(s,c,i)=>(re(s,typeof c!="symbol"?c+"":c,i),i);(function(s,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("@fuse-labs/core-client"),require("@fuse-labs/core-ui"),require("react"),require("@radix-ui/react-icons"),require("classnames"),require("@fuse-labs/shared-utils")):typeof define=="function"&&define.amd?define(["exports","@fuse-labs/core-client","@fuse-labs/core-ui","react","@radix-ui/react-icons","classnames","@fuse-labs/shared-utils"],c):(s=typeof globalThis!="undefined"?globalThis:s||self,c(s["@fuse-labs/terminal"]={},s.coreClient,s.coreUi,s.React,s.reactIcons,s.classNames,s.sharedUtils))})(this,function(s,c,i,l,L,F,A){"use strict";function C(n){return n&&typeof n=="object"&&"default"in n?n:{default:n}}var S=C(l),T=C(F),w={exports:{}},v={};/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var N=Object.getOwnPropertySymbols,B=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;function G(n){if(n==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(n)}function q(){try{if(!Object.assign)return!1;var n=new String("abc");if(n[5]="de",Object.getOwnPropertyNames(n)[0]==="5")return!1;for(var e={},t=0;t<10;t++)e["_"+String.fromCharCode(t)]=t;var r=Object.getOwnPropertyNames(e).map(function(a){return e[a]});if(r.join("")!=="0123456789")return!1;var o={};return"abcdefghijklmnopqrst".split("").forEach(function(a){o[a]=a}),Object.keys(Object.assign({},o)).join("")==="abcdefghijklmnopqrst"}catch{return!1}}q();/** @license React v17.0.2
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var z=S.default,k=60103;if(v.Fragment=60107,typeof Symbol=="function"&&Symbol.for){var E=Symbol.for;k=E("react.element"),v.Fragment=E("react.fragment")}var H=z.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,J=Object.prototype.hasOwnProperty,V={key:!0,ref:!0,__self:!0,__source:!0};function R(n,e,t){var r,o={},a=null,d=null;t!==void 0&&(a=""+t),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(d=e.ref);for(r in e)J.call(e,r)&&!V.hasOwnProperty(r)&&(o[r]=e[r]);if(n&&n.defaultProps)for(r in e=n.defaultProps,e)o[r]===void 0&&(o[r]=e[r]);return{$$typeof:k,type:n,key:a,ref:d,props:o,_owner:H.current}}v.jsx=R,v.jsxs=R,w.exports=v;const u=w.exports.jsx,f=w.exports.jsxs;function Y(e){var n=j(e,[]);const{device:t}=c.useDeviceContext(),{addStatus:r,removeStatus:o}=i.useDeviceStatusListContext();function a(){t.terminal.connect();let m=r("Prova messaggio di testo dello stato device",{type:"warning"});setTimeout(x=>o(m.id),1500)}function d(){t.terminal.disconnect()}return f(i.SettingsWidget,{children:[f(i.Group,{className:"!justify-start",children:[u(i.Button,{onClick:a,children:"Connect"}),u(i.Button,{onClick:d,children:"Disconnect"})]}),f("div",{className:"grid grid-cols-2 gap-4",children:[f(i.Group,{orientation:"vertical",children:[u(i.Label,{htmlFor:"serial-port",children:"Serial port"}),u(i.InputRaw,{id:"serial-port",disabled:!0,value:t.port})]}),f(i.Group,{orientation:"vertical",children:[u(i.Label,{htmlFor:"baud-rate",children:"Baud rate"}),u(i.InputRaw,{id:"baud-rate",value:t.baudrate,disabled:!0})]})]})]})}const P=S.default.createContext();function O(){let n=l.useContext(P);if(!n)throw new Error("useTerminalContext can only be used inside a TerminalProvider");return n}function D(t){var r=t,{terminal:n}=r,e=j(r,["terminal"]);const[o,a]=l.useState(n.log),[d,m]=l.useState(!0),x=p=>{a(g=>{let _=g.findIndex(y=>y.id==p.id);if(_>-1){let y=[...g];return y[_]=p,y}else return[...g,p]})};return u(P.Provider,{value:{terminal:n,data:o,appendData:x,autoscroll:d,setAutoscroll:m},children:e.children})}function K(){const{terminal:n,appendData:e}=O(),[t,r]=l.useState("");function o(a){if(a.preventDefault(),a.stopPropagation(),t.length){let d=n.sendMessage(t);e(d),r("")}}return f("form",{onSubmit:o,className:"flex flex-row space-x-2",children:[u(i.InputRaw,{type:"text",value:t,onChange:a=>r(a.target.value),className:T.default("flex-1","text-xs px-1.5 py-1","rounded-md","font-mono font-medium","bg-gray-900 border border-gray-600 text-gray-300","focus:border-blue-600 focus:outline-none focus:ring-1 focus:ring-blue-600"),autoCorrect:"false",autoComplete:"false",spellCheck:"false"}),u(i.Button,{type:"submit",children:u(L.PaperPlaneIcon,{})})]})}function Q(){const n=["\u28FE","\u28FD","\u28FB","\u28BF","\u287F","\u28DF","\u28EF","\u28F7"],[e,t]=l.useState(0);return l.useEffect(r=>{let o=setInterval(a=>t(d=>d>=n.length-1?0:d+1),80);return a=>clearInterval(o)}),n[e]}function X({data:n}){const{message:e,from:t,received:r}=n;return f("div",{children:[f("span",{className:T.default("font-bold","whitespace-pre",{"text-purple-500":t=="user","text-cyan-400":t=="server","text-amber-400":t=="device","text-pink-500":t=="controller"}),children:[t.padEnd(10," "),"\xA0",t=="user"&&!r?u(Q,{}):">","\xA0"]}),u("span",{children:e})]})}function Z(){const{terminal:n,data:e,appendData:t,autoscroll:r,setAutoscroll:o}=O(),a=l.useRef(),d=l.useRef();function m(){a.current&&(d.current||(d.current=Array.from(a.current.children).find(p=>p.hasAttribute("data-radix-scroll-area-viewport"))),d.current.scrollTop=d.current.scrollHeight)}l.useEffect(p=>{r&&setTimeout(g=>{m(),o(!0)},50)},[r,e,o]),l.useEffect(p=>{if(!n)return;let g=_=>t(_);return n.onMessageReceived(g),_=>n.offMessageReceived(g)},[t,n]);function x(p){r&&o(!1)}return f("div",{className:"flex-1 flex flex-col space-y-3 overflow-hidden",children:[u("div",{className:"flex-1 overflow-hidden",children:u(i.ScrollArea,{ref:a,className:"h-full px-1 rounded-md bg-gray-800 text-gray-200 font-semibold font-mono text-xs",onScroll:x,children:e==null?void 0:e.map((p,g)=>u(X,{data:p},`line-${p.id}`))})}),f(i.Group,{className:"!justify-start text-xs font-normal",children:[u(i.CheckboxRaw,{checked:r,onCheckedChange:o}),u(i.Label,{children:"Scroll automatically to bottom on new message"})]})]})}function U(){const{device:n}=c.useDeviceContext();return u(i.Widget,{title:"Terminal",version:"0.1",className:"h-96",children:f(D,{terminal:n.terminal,children:[u(Z,{}),u(K,{})]})})}const b=Object.freeze({None:0,CarriageReturn:1,NewLine:2,CarriageReturnAndNewLine:3});class I{constructor(e,{autoConnect:t=!0}={}){h(this,"_socket");h(this,"_isOpen",!1);h(this,"deviceId");h(this,"lineEnding",b.NewLine);h(this,"useCarriageReturn",!1);h(this,"_log",[]);if(console.log("Creating terminal for device ID",e.id),this.deviceId=e.id,this._socket=e.sockets.fuseLabs.terminal,!this._socket)throw console.log(e),new Error("Missing terminal socket for device");this.onMessageReceived(r=>{this._log.push(r),this._log.length>30&&this._log.shift()}),t&&this.connect()}get isOpen(){return this._isOpen}get log(){return this._log}connect(e){this._socket.emit("open",this.deviceId,t=>{console.log("Callback on connect, result:",t),this._isOpen=t,t&&(e==null||e(t))})}disconnect(){this._socket.emit("close",this.deviceId)}sendMessage(e){console.log("Sending message:",e);let t={id:A.generateUniqueID(),message:this._formatMessage(e),from:"user",deviceId:this.deviceId};return this._socket.emit("message",t),t}onMessageReceived(e){this._socket.on("message",e)}offMessageReceived(e){this._socket.off("message",e)}clearLog(){this._log=[]}_formatMessage(e){switch(this.lineEnding){case b.NewLine:return e.trim()+`
`;case b.CarriageReturn:return e.trim()+"\r";case b.CarriageReturnAndNewLine:return e.trim()+`\r
`;case b.None:default:return e.trim()}}}class $ extends c.ClientPlugin{constructor(e){super(e);c.ClientDeviceManager.shared.addEventListener("updatedDevices",this.provision)}provision(){const e=c.ClientDeviceManager.shared.devices;return e.forEach(t=>{t.terminal?console.warn("Trying setting terminal on device but device.terminal already exists"):(t.terminal=new I(t),console.log("Added terminal plugin to device",t.name))}),t=>{e.forEach(r=>{typeof r.terminal==I&&delete r.terminal})}}}s.MarlinTerminalSettingsWidget=Y,s.MarlinTerminalWidget=U,s.TerminalProvider=D,s.default=$,s.useTerminalContext=O,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
