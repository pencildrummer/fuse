var me=Object.defineProperty;var O=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable;var T=(n,l,f)=>l in n?me(n,l,{enumerable:!0,configurable:!0,writable:!0,value:f}):n[l]=f,C=(n,l)=>{for(var f in l||(l={}))Q.call(l,f)&&T(n,f,l[f]);if(O)for(var f of O(l))R.call(l,f)&&T(n,f,l[f]);return n};var I=(n,l)=>{var f={};for(var a in n)Q.call(n,a)&&l.indexOf(a)<0&&(f[a]=n[a]);if(n!=null&&O)for(var a of O(n))l.indexOf(a)<0&&R.call(n,a)&&(f[a]=n[a]);return f};var u=(n,l,f)=>(T(n,typeof l!="symbol"?l+"":l,f),f);(function(n,l){typeof exports=="object"&&typeof module!="undefined"?l(exports,require("socket.io-client"),require("lodash"),require("yup"),require("react"),require("@fuse-labs/shared-utils"),require("react-intl")):typeof define=="function"&&define.amd?define(["exports","socket.io-client","lodash","yup","react","@fuse-labs/shared-utils","react-intl"],l):(n=typeof globalThis!="undefined"?globalThis:n||self,l(n["@fuse-labs/core-client"]={},n.socket_ioClient,n.lodash,n.yup,n.React,n.sharedUtils,n.reactIntl))})(this,function(n,l,f,a,v,S,V){"use strict";function A(i){return i&&typeof i=="object"&&"default"in i?i:{default:i}}var D=A(f),E=A(v);function N(i,e){return fetch(i,e).then(t=>t.json())}function X(i,e){return N(i,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}const Z="http://localhost:8888";function m(i){let e=[Z,i].join("/").replace("@","scope:"),t=l.io(e);return t.on("connect",s=>{}),t}const _=m("@fuse-labs/core"),M=Object.freeze({FDMPrinter:"fdm_printer",MSLAPrinter:"msla_printer",CNC:"cnc",Laser:"laser"}),ee=a.object({name:a.string().required(),version:a.string().required(),_settings:a.boolean().required(),_hasPages:a.boolean().required(),_hasTabs:a.boolean().required(),_hasSocket:a.boolean().required(),_hasDeviceSocket:a.boolean().required(),_fuse:a.object().required(),_active:a.boolean().required(),_system:a.boolean().required()});a.object({name:a.string().required(),version:a.string().required(),fuse:a.object().required()});class z{constructor(e){u(this,"name");u(this,"version");u(this,"_fuse");u(this,"_settings",!1);u(this,"_hasPages",!1);u(this,"_hasTabs",!1);u(this,"_hasSocket");u(this,"_hasDeviceSocket");u(this,"_active",!1);u(this,"_system");let t=ee.validateSync(e);Object.assign(this,t),this.hasSocket&&(this.socket=m(this.name)),typeof this.provision=="function"&&this.provision()}get settings(){return this._settings}get hasPages(){return this._hasPages}get url(){return this._fuse.pagesUrl||this.name}get hasTabs(){return this._hasTabs}get tabsUrl(){return this._fuse.tabsUrl||this.name}get hasSocket(){return this._hasSocket}get hasDeviceSocket(){return this._hasDeviceSocket}get active(){return this._active}get system(){return this._system}get deviceTypes(){return this._fuse.devices=="*"?Object.values(M):this._fuse.devices}get displayTitle(){return this._fuse.title||this.name}}const w=class{constructor(){u(this,"_initialized",!1);u(this,"_plugins",[]);u(this,"_activePluginsNames",[])}get initialized(){return this._initialized}get plugins(){return this._plugins}get activePluginsNames(){return this._activePluginsNames}get activePlugins(){return this._plugins.filter(e=>e.active)}getPlugin(e){return this._plugins.find(t=>t.name==e)}init(e){this._plugins=(e==null?void 0:e.map(t=>{let s=w._registeredPlugins[t.name];return s?new s(t):new z(t)}))||[],console.log("INIT MANAGER Plugins",this._plugins),this._initialized=!0}static registerPlugin(e,t){w._registeredPlugins[e]=t}};let j=w;u(j,"_registeredPlugins",{});class h{constructor(){throw new Error("Use ClienPluginManager.shared instead")}static get shared(){return h.sharedInstance||(h.sharedInstance=new j),h.sharedInstance}}h.registerPlugin=j.registerPlugin;const x=a.object({id:a.string().required(),name:a.string().defined().required(),port:a.string().defined().required(),baudrate:a.number().defined().required(),profileId:a.string().defined().required(),serialNumber:a.string().nullable().default(null),vendorId:a.string().nullable().default(null),productId:a.string().nullable().default(null)});class y{constructor(e){u(this,"id");u(this,"name");u(this,"port");u(this,"baudrate");u(this,"profileId");u(this,"profile");u(this,"serialNumber");u(this,"vendorId");u(this,"productId");u(this,"plugins");var s,o;let t=x.validateSync(e);Object.assign(this,t),this.socket||(this.socket=m(`device:${t.id}`)),this.plugins=(s=h.shared.plugins)==null?void 0:s.filter(r=>{var c;return(c=r.deviceTypes)==null?void 0:c.includes(t.profile.type)}),(o=this.plugins)==null||o.forEach(r=>{if(!r.hasDeviceSocket)return;let c=r.name.split("/").map(d=>D.default.camelCase(d)).join(".");if(!D.default.get(this,"sockets."+c)){let d=m(`device:${this.id}/${r.name}`);D.default.set(this,"sockets."+c,d)}})}get immutableKeys(){return["id","profile","serialNumber","vendorId","productId"]}update(e){let t=Object.keys(e).reduce((o,r)=>(this.immutableKeys.includes(r)?console.warn("Trying to update an immutable ClientDevice property:",r):(console.log("RES",o),o[r]=e[r]),o),C({},this)),s=x.validateSync(t);Object.assign(this,s)}}class te extends EventTarget{constructor(){super();u(this,"_initialized",!1);u(this,"_devices",[])}get initialized(){return this._initialized}get devices(){return this._devices}init(e){this._devices=(e==null?void 0:e.map(t=>new y(t)))||[],this.dispatchEvent(new Event("updatedDevices")),_.on("devices:added",this._handleDeviceAdded),_.on("devices:updated",this._handleDeviceUpdated),_.on("devices:removed",this._handleDeviceRemoved),console.log("INITED MANAGER Devices",this._devices),this._initialized=!0}getDevice(e){return this._devices.find(t=>t.id==e)}_handleDeviceAdded(e){let t=new y(e);this._devices=[...this._devices,t],this.dispatchEvent(new Event("updatedDevices"))}_handleDeviceUpdated(e){let t=this._devices.find(s=>s.id===e.id);t?t.update(e):console.log("Received request to update local device but no device has been found with id",e.id),this.dispatchEvent(new Event("updatedDevices"))}_handleDeviceRemoved(e){this._devices=this._devices.filter(t=>t.id!==e.id),this.dispatchEvent(new Event("updatedDevices"))}}class p{constructor(){throw new Error("Use ClientDeviceManager.shared instead")}static get shared(){return p.sharedInstance||(p.sharedInstance=new te),p.sharedInstance}}const U=E.default.createContext();function k(){const i=v.useContext(U);if(!i)throw new Error("useAppContext can only be used inside an AppProvider");return i}const L=E.default.createContext();function ie(){const i=v.useContext(L);if(!i)throw new Error("useDeviceContext can be used only inside a DeviceProvider");return i}function F(i){const{devices:e}=k();return v.useMemo(t=>e.find(s=>s.id==i),[i,e])}function ne(i,e){let t=F(i);return v.useMemo(s=>{var o;return(o=t==null?void 0:t.plugins)==null?void 0:o.find(r=>r.url==e||r.name===e)},[t,e])}function re(i){const{plugins:e}=k();return v.useMemo(t=>e.find(s=>s.url==i||s.name===i),[i,e])}function H(i){p.shared.initialized||p.shared.init(i);const[e,t]=v.useState(p.shared.devices);return v.useEffect(s=>{const o=r=>t(p.shared.devices);return p.shared.addEventListener("updatedDevices",o),r=>{p.shared.removeEventListener("updatedDevices",o)}},[]),e}function K(i){h.shared.initialized||h.shared.init(i),v.useEffect(s=>{function o(c){let d=h.shared.getPlugin(c);d._active=!0,t(g=>[...g])}function r(c){let d=h.shared.getPlugin(c);d._active=!1,t(g=>[...g])}_.on("plugins:activated",o),_.on("plugins:deactivated",r)},[]);const[e,t]=v.useState(h.shared.plugins);return e}function $(i){const[e,t]=v.useState(i||{});return v.useEffect(s=>{_.on("profiles:added",o=>{const r=S.pathCase(o.brand);t(c=>{let d=C({},c);return d[r]=d[r]||[],d[r].push(o),d})}),_.on("profiles:updated",o=>{t(r=>{let c=S.pathCase(o.brand),d=r[c].findIndex(b=>b.id==o.id);if(d==-1)return console.error("Unable to find index for received updated profile with id",o.id),r;let g=C({},r);return g[c].splice(d,1,o),g})}),_.on("profiles:deleted",o=>{t(r=>{let c=o.split("."),d=S.pathCase(c[0]);if(S.pathCase(c[1]),r[d]){let g=C({},r);return g[d]=g[d].filter(b=>b.id!=o),g}else return console.warn('Received deleted profile event for profile "'+o+'" but profile is not found'),r})})},[]),e}function se(){const[i,e]=v.useState([]);return v.useEffect(t=>{_.emit("serial:list",s=>{e(s)})},[]),i}var G={exports:{}},P={};/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var J=Object.getOwnPropertySymbols,oe=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;function de(i){if(i==null)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(i)}function ue(){try{if(!Object.assign)return!1;var i=new String("abc");if(i[5]="de",Object.getOwnPropertyNames(i)[0]==="5")return!1;for(var e={},t=0;t<10;t++)e["_"+String.fromCharCode(t)]=t;var s=Object.getOwnPropertyNames(e).map(function(r){return e[r]});if(s.join("")!=="0123456789")return!1;var o={};return"abcdefghijklmnopqrst".split("").forEach(function(r){o[r]=r}),Object.keys(Object.assign({},o)).join("")==="abcdefghijklmnopqrst"}catch{return!1}}ue();/** @license React v17.0.2
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ce=E.default,B=60103;if(P.Fragment=60107,typeof Symbol=="function"&&Symbol.for){var W=Symbol.for;B=W("react.element"),P.Fragment=W("react.fragment")}var le=ce.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,fe=Object.prototype.hasOwnProperty,ve={key:!0,ref:!0,__self:!0,__source:!0};function Y(i,e,t){var s,o={},r=null,c=null;t!==void 0&&(r=""+t),e.key!==void 0&&(r=""+e.key),e.ref!==void 0&&(c=e.ref);for(s in e)fe.call(e,s)&&!ve.hasOwnProperty(s)&&(o[s]=e[s]);if(i&&i.defaultProps)for(s in e=i.defaultProps,e)o[s]===void 0&&(o[s]=e[s]);return{$$typeof:B,type:i,key:r,ref:c,props:o,_owner:le.current}}P.jsx=Y,P.jsxs=Y,G.exports=P;const q=G.exports.jsx;function he(c){var d=c,{devices:i,profiles:e,plugins:t,locale:s="en",messages:o}=d,r=I(d,["devices","profiles","plugins","locale","messages"]);const g=$(e),b=K(t),pe=v.useMemo(Pe=>b==null?void 0:b.filter(be=>be.active),[b]),_e=H(i);return q(U.Provider,{value:{devices:_e,profiles:g,plugins:b,activePlugins:pe},children:q(V.IntlProvider,{defaultLocale:"en",locale:s,messages:o,children:r.children})})}function ge(t){var s=t,{device:i}=s,e=I(s,["device"]);return q(L.Provider,{value:{device:i},children:e.children})}n.AppProvider=he,n.ClientDevice=y,n.ClientDeviceManager=p,n.ClientDeviceType=M,n.ClientPlugin=z,n.ClientPluginManager=h,n.DeviceProvider=ge,n.coreSocket=_,n.fetcher=N,n.fetcherPOST=X,n.socket=m,n.useAppContext=k,n.useDevice=F,n.useDeviceContext=ie,n.useDevicePlugin=ne,n.usePlugin=re,n.useProviderDevices=H,n.useProviderPlugins=K,n.useProviderProfiles=$,n.useSerialPorts=se,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
